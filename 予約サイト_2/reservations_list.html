<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>予約一覧</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h1 { margin: 0 0 6px; }
    #msg { font-size: 14px; color: #666; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eee; }
    .btn {
      display:inline-block; padding:8px 14px; border-radius:6px;
      background:#2563eb; color:#fff; text-decoration:none; font-weight:600; border:0; cursor:pointer;
    }
  </style>
</head>
<body>
  <h1>現在の予約一覧</h1>
  <div id="msg">読み込み中…</div>

  <table id="reservation-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>日付</th>
        <th>時間</th>
        <th>企業名</th>
        <th>匿名</th>
        <th>カテゴリ</th>
        <th>備考</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody><!-- ここに行を追加 --></tbody>
  </table>

  <div style="margin-top:16px;">
    <button type="button" class="btn" onclick="location.href='admin_dashboard.html'">管理画面に戻る</button>
  </div>

  <script>
    const API_URL = "./api.php";

    function isoToJP(iso) {
      const m = iso?.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return iso ?? "";
      const [_, y, mo, d] = m;
      return `${y}年${+mo}月${+d}日`;
    }

    async function loadList() {
      const tbody = document.querySelector('#reservation-table tbody');
      const msg   = document.getElementById('msg');
      tbody.innerHTML = "";
      msg.textContent = "読み込み中…";

      try {
        const res  = await fetch(`${API_URL}?action=list`);
        const data = await res.json();

        if (data && data.ok === false) {
          msg.textContent = "読み取りが失敗しました: " + (data.error || "不明なエラー");
          return;
        }

        const list = Array.isArray(data) ? data : [];
        list.sort((a, b) => {
          const ka = `${a.date || ""}-${a.time || ""}`;
          const kb = `${b.date || ""}-${b.time || ""}`;
          return ka.localeCompare(kb);
        });

        if (!list.length) {
          msg.textContent = "予約はありません";
          return;
        }
        msg.textContent = "";

        list.forEach(r => {
          let anonymous = r.anonymous;
          let category  = r.category;
          let note      = r.note;

          if (typeof anonymous === "undefined" && typeof category === "undefined" && typeof note === "undefined" && r.memo) {
            const m = fromMemo(r.memo);
            anonymous = m.anonymous;
            category  = m.category;
            note      = m.note;
          }

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.id ?? ''}</td>
            <td>${isoToJP(r.date ?? '')}</td>
            <td>${r.time ?? ''}</td>
            <td>${r.name ?? ''}</td>
            <td>${(anonymous === true || anonymous === "はい") ? "はい" : (anonymous || "いいえ")}</td>
            <td>${category ?? ''}</td>
            <td>${note ?? ''}</td>
            <td><button data-id="${r.id}" class="delete">削除</button></td>
          `;
          tbody.appendChild(tr);
        });
      } catch (e) {
        console.error(e);
        msg.textContent = "読み取りが失敗しました（通信エラー）";
      }
    }

    document.addEventListener('click', async (ev) => {
      const btn = ev.target.closest('button.delete');
      if (!btn) return;
      const id = Number(btn.dataset.id);
      if (!id) return;
      if (!confirm(`ID: ${id} を削除します。よろしいですか？`)) return;

      try {
        const res = await fetch(`${API_URL}?action=delete`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id })
        });
        const data = await res.json();
        if (data && data.ok === true) {
          await loadList();
        } else {
          alert("削除失敗: " + (data?.error || "不明なエラー"));
        }
      } catch (e) {
        console.error(e);
        alert("通信エラーで削除できませんでした");
      }
    });

    document.addEventListener('DOMContentLoaded', loadList);
  </script>
</body>
</html>
