<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>アカウント設定</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }

    h1 {
      text-align: center;
    }

    .section {
      margin-top: 30px;
    }

    label,
    input {
      display: block;
      margin: 5px 0;
    }

    input {
      padding: 5px;
      width: 250px;
    }

    button {
      margin-top: 10px;
      padding: 8px 12px;
    }
  </style>
</head>

<body>
  <h1>アカウント設定</h1>

  <div class="section">
    <h2>一般ユーザー情報の変更</h2>
    <label for="user-id">ユーザーID:</label>
    <input type="text" id="user-id">
    <label for="user-pass">ユーザーパスワード:</label>
    <input type="password" id="user-pass">
    <button onclick="updateAccount('user')">保存</button>
  </div>

  <div class="section">
    <h2>管理者情報の変更</h2>
    <label for="admin-id">管理者ID:</label>
    <input type="text" id="admin-id">
    <label for="admin-pass">管理者パスワード:</label>
    <input type="password" id="admin-pass">
    <button onclick="updateAccount('admin')">保存</button>
  </div>

  <div class="section">
    <button onclick="goBack()">管理画面に戻る</button>
  </div>

  <script>
    // 管理者ログイン確認（既存の方法に合わせる）
    if (sessionStorage.getItem("isAdminLoggedIn") !== "true") {
      window.location.href = "admin_login.html";
    }

    // 現在のIDをサーバーから取得して入力欄に反映
    async function loadCurrentIds() {
      try {
        const res = await fetch('./auth.php?action=get_ids&ts=' + Date.now(), {
          headers: { 'Cache-Control': 'no-store' }, cache: 'no-store'
        });
        const json = await res.json();
        // 既存のIDを初期表示（パスワードは安全のため表示しない）
        if (json?.user?.id) document.getElementById('user-id').value = json.user.id;
        if (json?.admin?.id) document.getElementById('admin-id').value = json.admin.id;
      } catch (e) {
        console.error(e);
        alert('現在のIDを取得できませんでした');
      }
    }

    // role: 'user' | 'admin'
    async function updateAccount(role) {
      const idInput = document.getElementById(role + '-id').value.trim();
      const passInput = document.getElementById(role + '-pass').value;

      // 渡したプロパティだけ更新される（空欄は上書きしない）
      const payload = { role };
      if (idInput) payload.id = idInput;
      if (passInput) payload.password = passInput;

      try {
        const res = await fetch('./auth.php?action=update_account&ts=' + Date.now(), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Cache-Control': 'no-store' },
          cache: 'no-store',
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        if (json && json.ok === false) {
          alert(json.error || '更新に失敗しました');
          return;
        }
        // 成功メッセージ（画面の文言に合わせる）
        alert((role === 'admin' ? '管理者' : 'ユーザー') + '情報を更新しました');
        // パスワード欄は毎回クリア
        document.getElementById(role + '-pass').value = '';
      } catch (e) {
        console.error(e);
        alert('通信エラー');
      }
    }

    function goBack() {
      window.location.href = "admin_dashboard.html";
    }

    // 既存の onclick を使うために公開
    window.updateAccount = updateAccount;
    window.goBack = goBack;

    // 初期表示時にIDをロード
    loadCurrentIds();
  </script>
</body>

</html>