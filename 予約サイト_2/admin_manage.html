<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>管理画面：予約不可日の設定</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #eee;
        }

        input[type="date"] {
            padding: 5px;
        }

        button {
            padding: 5px 10px;
            margin: 5px;
        }
    </style>
</head>

<body>

    <!-- 管理画面に戻るボタン -->
    <button onclick="goBack()">← 管理画面に戻る</button>
    <div>
        <h3>予約不可日を追加</h3>
        <label>単一日:</label>
        <input type="date" id="blocked-date-input">
        <button onclick="addSingleDate()">追加</button>

        <h3>一括追加（範囲指定）</h3>
        <label>開始日:</label>
        <input type="date" id="start-date-input">
        <label>終了日:</label>
        <input type="date" id="end-date-input">
        <button onclick="addDateRange()">範囲を追加</button>
    </div>

    <table id="blocked-list">
        <thead>
            <tr>
                <th>日付</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            <!-- 非予約日がここに表示される -->
        </tbody>
    </table>

    <script>
        // ==== ローカル日付ヘルパ（UTCズレ防止） ====
        function pad2(n) { return String(n).padStart(2, '0'); }
        // "YYYY-MM-DD" -> local Date(00:00)
        function parseYmdToLocalDate(ymd) {
            const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(ymd || "");
            if (!m) return null;
            const y = +m[1], mo = +m[2], d = +m[3];
            return new Date(y, mo - 1, d);
        }
        // local Date -> "YYYY-MM-DD"
        function formatLocalDateToYmd(date) {
            return `${date.getFullYear()}-${pad2(date.getMonth() + 1)}-${pad2(date.getDate())}`;
        }
        function addDaysLocal(date, days) {
            return new Date(date.getFullYear(), date.getMonth(), date.getDate() + days);
        }

        // ==== API（キャッシュ無効化 & フォーマットゆれ吸収） ====
        async function fetchBlocked() {
            const res = await fetch('./api.php?action=blocked_list&ts=' + Date.now(), {
                headers: { 'Cache-Control': 'no-store' },
                cache: 'no-store'
            });
            const raw = await res.json();
            // APIが ["2025-10-01", ...] または [{date:"2025-10-01"}, ...] の両方に耐性
            const list = Array.isArray(raw) ? raw.map(x => {
                if (typeof x === 'string') return { date: x };
                if (x && typeof x === 'object') return { date: x.date || x['日付'] || '' };
                return { date: '' };
            }).filter(i => i.date) : [];
            // 重複除去
            const uniq = Array.from(new Set(list.map(i => i.date))).map(d => ({ date: d }));
            // 日付順
            uniq.sort((a, b) => a.date.localeCompare(b.date));
            return uniq;
        }

        async function addBlocked(date) {
            // reason はサーバー側で不要でも送っても問題なし（無視される）
            const res = await fetch('./api.php?action=blocked_add&ts=' + Date.now(), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Cache-Control': 'no-store' },
                cache: 'no-store',
                body: JSON.stringify({ date })
            });
            return res.json();
        }

        async function deleteBlocked(date) {
            const res = await fetch('./api.php?action=blocked_delete&ts=' + Date.now(), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Cache-Control': 'no-store' },
                cache: 'no-store',
                body: JSON.stringify({ date })
            });
            return res.json();
        }

        // ==== 画面描画 ====
        async function renderBlockedDates() {
            const list = await fetchBlocked();
            const tbody = document.querySelector('#blocked-list tbody');
            tbody.innerHTML = '';
            list.forEach(item => {
                const tr = document.createElement('tr');
                const tdDate = document.createElement('td');
                tdDate.textContent = item.date;
                const tdOp = document.createElement('td');
                const btn = document.createElement('button');
                btn.textContent = '削除';
                btn.onclick = async () => {
                    const r = await deleteBlocked(item.date);
                    if (r && r.ok === false) { alert(r.error || '削除に失敗しました'); return; }
                    await renderBlockedDates();
                };
                tdOp.appendChild(btn);
                tr.appendChild(tdDate);
                tr.appendChild(tdOp);
                tbody.appendChild(tr);
            });
        }

        // ==== 追加系（単日 / 範囲） ====
        async function addSingleDate() {
            const v = document.getElementById('blocked-date-input').value; // "YYYY-MM-DD"
            if (!v) return alert('日付を選択してください');
            if (!/^\d{4}-\d{2}-\d{2}$/.test(v)) return alert('日付はYYYY-MM-DDで指定してください');
            const r = await addBlocked(v); // ← 文字列そのまま送信（UTCにしない）
            if (r && r.ok === false) return alert(r.error || '追加に失敗しました');
            await renderBlockedDates();
        }

        async function addDateRange() {
            const s = document.getElementById('start-date-input').value; // "YYYY-MM-DD"
            const e = document.getElementById('end-date-input').value;
            if (!s || !e) return alert('開始日と終了日を指定してください');

            const sd = parseYmdToLocalDate(s); // ← ローカルDate
            const ed = parseYmdToLocalDate(e);
            if (!sd || !ed) return alert('日付の形式が不正です');
            if (sd > ed) return alert('日付の範囲が不正です');

            // 両端を含めてローカル日付で1日ずつ追加（UTC変換しない）
            for (let d = new Date(sd); d <= ed; d = addDaysLocal(d, 1)) {
                const ymd = formatLocalDateToYmd(d);   // ← "YYYY-MM-DD" をローカルで生成
                const r = await addBlocked(ymd);
                if (r && r.ok === false) return alert(r.error || '追加に失敗しました');
            }
            await renderBlockedDates();
        }

        // ==== 戻るボタン ====
        function goBack() { window.location.href = 'admin_dashboard.html'; }

        // ==== グローバルへ公開（HTMLの onclick をそのまま活かす） ====
        window.addSingleDate = addSingleDate;
        window.addDateRange = addDateRange;
        window.goBack = goBack;

        // 初期描画
        renderBlockedDates();
    </script>

</body>

</html>